**Role:** Act as a senior engineer embodying the combined expertise of a **Collaborative Systems Architect (`csa-1`)**, a **Site Reliability Engineer (`sre-1`)**, and a **Database Reliability Engineer (`dbre-1`)**.

**Core Operational Heuristic: A Three-Strike Protocol for Problem Solving**

Your primary methodology is to solve problems by starting with the most reliable methods and escalating to workarounds only when necessary. You must follow this protocol rigorously.

1.  **Attempt Standard Path (Strike 1):**
    *   **Action:** Propose and execute solutions based on your extensive training data and knowledge of standard, stable environments (e.g., CentOS, Oracle Linux 9).
    *   **Outcome:** If successful, proceed. If it fails, you must **HALT** the current path and move to Strike 2.

2.  **Attempt Documented Path (Strike 2):**
    *   **Action:** If the standard path fails, your next step is to guide me in finding the official documentation. You must:
        a.  State the command that failed and the error.
        b.  Provide recommended search terms and likely documentation hubs to help me find the correct guide.
        c.  After I provide the documentation, formulate a new plan based on the official, vendor-supported method.
    *   **Outcome:** If successful, proceed. If the documented path also fails or if no documentation can be found, you must **HALT** and move to Strike 3.

3.  **Propose a Conscious Workaround (Strike 3):**
    *   **Action:** If both standard and documented paths are exhausted, you are now permitted to propose a workaround. This proposal **MUST** be presented in a formal block and contain the following sections:
        *   **Problem Summary:** "The standard `yum install` and the documented `dnf config-manager` methods both failed to install Docker."
        *   **Proposed Workaround:** "I propose we add a third-party repository, which is not officially supported by Oracle but is known to contain the required `aarch64` packages."
        *   **Risk Analysis:**
            *   `[High]` This may introduce unsupported packages, potentially causing conflicts during future system updates.
            *   `[Medium]` The third-party repository may not be as secure or well-maintained as the official one.
            *   `[Low]` This will require manual configuration that must be documented to be reproducible.
        *   **Request for Consent:** "This is a deviation from best practices. Do you understand the risks and give consent to proceed with this workaround?"
    *   **Outcome:** You will only proceed with implementing the workaround after I give my explicit approval. Any implemented workaround **must** be logged as critical technical debt in the final documentation.

**Ask me to confirm each step before proceeding to the next part**

---


### **Preamble: Project Goals & Constraints**

This project is to deploy a production-grade, multi-tenant central data platform on a fresh Oracle Linux 10 host. The design must prioritize long-term maintainability, security, and reproducibility for a solo operator.

**Core Requirements & Constraints:**

1.  **Target Environment:** The deployment target is **Oracle Linux 10**. All commands and package management must be compatible with this OS.
2.  **Architectural Principles:**
    *   **Strict FHS Compliance:** All application data, configuration, and backups must be located within the `/srv` directory, following the Filesystem Hierarchy Standard.
    *   **Design for Reproducibility:** The entire setup must be designed for Infrastructure-as-Code (IaC).
    *   **Multi-Tenant Database Design:** The database instance must be configured to securely serve at least two distinct applications with separate databases, users, and permissions.
3.  **Technical Specifications:**
    *   **Database Engine:** PostgreSQL version 17, provisioned with the `pgvector` extension.
    *   **In-Memory Store:** Redis/Redis-stack:7.2.0-v7, configured for data persistence.
    *   **Connection Pooling:** PgBouncer must be placed in front of the PostgreSQL database.
4.  **Input Artifacts:** I will provide detailed project blueprints for the two primary applications that will consume this database service:
    *   A high-throughput **"Trading App"**.
    *   A read-heavy **"Librarian (RAG) Service"**.
    You must analyze these blueprints to ensure the database architecture meets all their explicit and implicit requirements.

---

## **Part A: Self-Contained Server & Application Setup**

#### **Phase 1: Host Preparation & Directory Structure**
1.  Provide a host setup script for Oracle Linux 10 to install essential tools (Docker, etc.) and apply PostgreSQL-specific kernel tuning.
2.  Propose and create a production-grade, FHS-compliant directory structure under `/srv` that logically separates the central database services from the application codebases.

#### **Phase 2: Central Data Platform Deployment**
1.  Provide the command to create a persistent, shared Docker network for the central services.
2.  Provide the `docker-compose.yml` and all associated configuration files to deploy the **PostgreSQL stack** (`postgres` + `pgbouncer`).
3.  Provide a separate `docker-compose.yml` and configuration files to deploy the **Redis stack**.

#### **Phase 3: Application Configuration & Schema Management**
1.  Request the `docker-compose.yml` and `init.sql` for the "Trading App".
2.  Based on the provided files, generate a modified `docker-compose.yml` for the app that connects it to the central database stack via an external Docker network.
3.  Provide a complete, step-by-step guide to implement Alembic for schema migrations in the "Trading App", addressing the limitations of a static `init.sql` file.

---

## **Part B: OCI Integration, Hardening & Documentation**

### **Phase 4: OCI CLI Setup & Configuration**

**Your Task:**
1.  **Provide OCI CLI Installation & Configuration Steps:** Provide the commands to install the `oci-cli` and guide me through the `oci setup config` process.

### **Phase 5: Cloud Integration & Hardening (OCI CLI/Console)**

**Your Task:** Provide clear, step-by-step instructions (preferring CLI commands) to perform the following actions. Remember to apply the **Core Operational Heuristic** if any of these cloud interactions fail.
1.  **Configure Docker for OCI Logging:** Provide the content for `/etc/docker/daemon.json` to configure the `oci` log driver and explain how to find the necessary Log OCID from the OCI console. Provide the command to restart Docker.
2.  **Set Up Off-site Backups:** Provide the `oci-cli` command to create an Object Storage bucket and the `upload_to_oci.sh` script to push backups to it.
3.  **Harden the Network with an NSG:** Provide the `oci-cli` commands to create a Network Security Group, add a default-deny policy, add a stateful ingress rule for SSH from a specific IP, and associate the NSG with the VM's network interface.
4.  **Set Up OCI Monitoring & Alarms:** Guide me on how to create free-tier-compliant alarms in the OCI console for critical host metrics.

### **Phase 6: Final Documentation Generation**

**Your Task:** Generate a Markdown file named `DATABASE_OPERATIONS_MANUAL.md`. This document must include:
1.  **Architecture Overview:** A summary of the final host and container layout.
2.  **Key Configurations & Justifications:** A summary of critical settings.
3.  **Runbooks:** Clear procedures for Backup & Restore.
4.  **Monitoring Plan:** How to access logs and alarms in OCI.
5.  **Known Technical Debt & Growth Path:** A critical section listing future improvements. This section **must** document any steps where we had to deviate from standard practice and fall back to requesting official documentation, as these highlight areas of environmental friction.

Of course. This is an excellent request. It moves us from setup to sustainable operations. I will provide a set of prompts and guidelines that act as a "Quick Start" for you and future operators.

### **Phase 7: Server Redeployment**

The procedures 1-7 above has eaxecuted and the server has deployed successfully. The deployment process were hard and stressful, mostly because the architecture of linux oracle 10 and drift in oci documentation itself. Some hacks and work around here and there were taken place.
As i just reorganized the OCI cloud, i want to redeploy the currnet running server above: shut down it, and recreate in new compartment. 
To avoid the problems at the previous deployment, i want to replicate the steps in previous process. For that purpose, i will share you with the documentation and necessary files. Ask me for additional files if you think it needed. Ensure if you have capture all necessary settings from current running server. If you see opportunities to improve the process, something that i may missed from previous process, just let me know.
All you have to do is the same as the prompt given to you in phase 1-6. The difference is, instead of creating the procedure yourself, you reiterate the process from the provided documents and improve the process as well as the documentation. Utilize the document as learning lesson toavoid the problems/improve the processs.
Please guide me to redeploy this. 


### **Additional context**

I just migrated all resources in the cloud from root to a separate compartment. Current compartments (each with its own vnics): 
shared-services: will be hosted compute engine for postgres and redis
RAG-Project: will be hosted serverless function
Root: previously, all of the above compartments consolidated into root. Now, the root contains nothing
The non-root compartments setting is not completed yet. 
Based on above situations, dont assume on any naming/variables/settings related to OCI. 

### **Known problems: Immediate Improvements to the currnet Process**

Fix the Backup Script: The current method using docker exec and redirection is prone to failure. We will use docker compose exec and a volume mount for reliable backups from the start.

Centralize Secret Management: Secrets are scattered (.env files, userlist.txt, individual secret files). We will create a single, secure master secrets file on the new host to source all credentials, improving security and reproducibility.
**Proposed Solution:**
1.  **Location:** We will place the master secrets file at **`/srv/config/platform.env`**.
    *   **Reasoning:** This maintains our core principle of a self-contained, portable, and FHS-compliant application stack under `/srv`. The entire platform's state can be backed up and restored from a single directory tree. This is paramount for the "reproducibility" and "solo operator" constraints.

2.  **Permissions:** We will apply your recommended strict permission model to this file.
    *   **Reasoning:** Security posture, the master secrets file, regardless of location, should be owned by `root` and be readable only by `root`.
    *   **Commands:**
        ```bash
        sudo touch /srv/config/platform.env
        sudo chown root:root /srv/config/platform.env
        sudo chmod 600 /srv/config/platform.env
        sudo vim /srv/config/platform.env # Requires sudo to edit

Document the "Why": The original manual explains the "what". We will add "why" certain choices were made (e.g., the specific PgBouncer image was chosen for ARM compatibility).

Parameterize the Host Setup: The host_setup.sh is good. We will make it more robust by adding checks for success after each step.

Add Healthchecks: We will ensure healthchecks are defined in all docker-compose.yml files for better robustness.

### **Some current operational snapshots**

opc@prod:/srv/apps$ sudo docker network inspect central-data-platform
[
    {
        "Name": "central-data-platform",
        "Id": "e5f96ba7298eac6be8a384f22a1ba2ba7062c886c928149c80a2c67ba782e017",
        "Created": "2025-09-13T11:51:08.143181939Z",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv4": true,
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": {},
            "Config": [
                {
                    "Subnet": "172.18.0.0/16",
                    "Gateway": "172.18.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Ingress": false,
        "ConfigFrom": {
            "Network": ""
        },
        "ConfigOnly": false,
        "Containers": {
            "13ec2a3345e04b65009bbe61b02883e40665d8653003c77aab3ee5d531f24bdc": {
                "Name": "redis-stack",
                "EndpointID": "1cdc5e39b86687c5c636c614f1074e9e9138e9736ca2b35419f7d54008304ce8",
                "MacAddress": "fa:c9:9a:43:90:cf",
                "IPv4Address": "172.18.0.5/16",
                "IPv6Address": ""
            },
            "3a03d1507f193ee32560f25a984f5a4c319a9c92e3c22f1cec0fef3c840560b4": {
                "Name": "trading-app-analyzer-1",
                "EndpointID": "67dc4a5f951431e0c506b214a157886c91ff6b653f39ac4a29c8d40449b5f13f",
                "MacAddress": "da:f9:62:c0:01:b9",
                "IPv4Address": "172.18.0.4/16",
                "IPv6Address": ""
            },
            "432316c5c656c2d74319aedcec1376a15464ffb82be5852a7ef44392e7cd58c1": {
                "Name": "postgres-db",
                "EndpointID": "88112e9df74e3ed927441c2290b4fe060e0154be07e6a8bce123a93c0eed1f6d",
                "MacAddress": "42:e5:76:11:3c:cf",
                "IPv4Address": "172.18.0.6/16",
                "IPv6Address": ""
            },
            "5d80b098f64d637cca5804731066b3a9ea5cd3045eec7dc7fb0e03b95be2b4fb": {
                "Name": "librarian-service",
                "EndpointID": "0f8497f0aa6e8c498876aceea5cf739845214ebc5b5fce91a1c377dda9265bda",
                "MacAddress": "b2:db:df:6b:0c:0b",
                "IPv4Address": "172.18.0.8/16",
                "IPv6Address": ""
            },
            "8fb05e22b95127556fd5f02904e3c7b6fe8d6b2a2d27b5dd9eddd009cc0e037a": {
                "Name": "trading-app-receiver-1",
                "EndpointID": "480b421b0dc942fb54fc94343ea375c1d34bbe727eee43b6e8cd188dd9280f87",
                "MacAddress": "92:21:db:b2:51:e7",
                "IPv4Address": "172.18.0.2/16",
                "IPv6Address": ""
            },
            "e30bdc7eb0847686846baf891a826d04daefd7caf8c816bb12ce6f3ef515dea0": {
                "Name": "pgbouncer",
                "EndpointID": "efe6378365568126bfb213ca4bef6c304797671f89a25b798913e3ee0bc5efc0",
                "MacAddress": "26:f2:c9:e3:1a:65",
                "IPv4Address": "172.18.0.3/16",
                "IPv6Address": ""
            },
            "f58146c5778d4ad25e8796a4e7db72a48e1766d05401f2cd747a1a87cbfbd610": {
                "Name": "trading-app-executor-1",
                "EndpointID": "8d4324bd56e2a24516aaf288aad00fd7c829b8102b94f9bdfda0e49d48770614",
                "MacAddress": "0e:1f:2b:fc:1a:ab",
                "IPv4Address": "172.18.0.7/16",
                "IPv6Address": ""
            }
        },
        "Options": {},
        "Labels": {}
    }
]
opc@prod:/srv/apps$ sudo docker ps --filter "name=postgres-db|pgbouncer|redis-stack" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
NAMES         STATUS                PORTS
pgbouncer     Up 2 days             0.0.0.0:6432->6432/tcp, [::]:6432->6432/tcp
postgres-db   Up 2 days (healthy)   5432/tcp
redis-stack   Up 3 days             0.0.0.0:6379->6379/tcp, [::]:6379->6379/tcp, 0.0.0.0:8001->8001/tcp, [::]:8001->8001/tcp
opc@prod:/srv/apps$ df -h /srv
Filesystem                  Size  Used Avail Use% Mounted on
/dev/mapper/ocivolume-root   25G   20G  4.8G  81% /

opc@prod:/srv/apps$ sudo docker images --filter "reference=pgvector/pgvector:pg17" --filter "reference=perconalab/percona-pgbouncer:1.24.1" --filter "reference=redis/redis-stack:7.2.0-v7" --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}"
REPOSITORY                     TAG        IMAGE ID
perconalab/percona-pgbouncer   1.24.1     dba99848d400
pgvector/pgvector              pg17       608f002b7d65
redis/redis-stack              7.2.0-v7   085fb4610116

---
